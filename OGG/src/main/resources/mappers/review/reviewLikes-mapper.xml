<?xml version="1.0" encoding="UTF-8"?>
<!-- mybatis mapper 설정 파일임을 선언한다. -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

	<mapper namespace="com.project.ogg.review.model.mapper.ReviewLikesMapper">
	
	<!-- REVIEW_LIKES sql-->
	<sql id="reviewLikesSql">
		SELECT L_NO,
		       M_NO,
		       RV_NO,
		       CMT_NO,
		       F_CODE,
		       F_TYPE,
		       F_LIKES,
		       F_STAR
		FROM REVIEW_LIKES
	</sql>
	
	<!-- FILM resultMap-->
	<resultMap type="Film" id="filmResultMap">
		<id property="fCode" column="F_CODE" />
		<result property="fTitle" column="F_TITLE" />
	</resultMap>	

	<!-- REVIEW_LIKES resultMap-->
	<resultMap type="ReviewLikes" id="reviewLikesResultMap">
		<id property="lNo" column="L_NO" />
		<result property="fTitle" column="F_TITLE" />
		<result property="mNo" column="M_NO" />
		<result property="rvNo" column="RV_NO" />
		<result property="cmtNo" column="CMT_NO" />
		<result property="fCode" column="F_CODE" />
		<result property="fType" column="F_TYPE" />
		<result property="fLikes" column="F_LIKES" />
		<result property="fStar" column="F_STAR" />
	</resultMap>	
	
	<!-- 영화 체크 -->		
	<select id="checkFilm" parameterType="_int" resultMap="filmResultMap">
		SELECT *
		FROM FILM
		WHERE F_CODE = #{fCode}
	</select>
	
	<!-- 영화 등록 -->
	<insert id="insertFilm" parameterType="Film">
		INSERT INTO FILM (
	            F_CODE,
	            F_TYPE,
	            F_TITLE 
			)
			VALUES(
				#{fCode},
				DEFAULT,
				#{fTitle}
	      	)	
	</insert>
	
	<!-- 평가 조회 (영화 별점) -->
	<select id="selectStar" parameterType="ReviewLikes" resultMap="reviewLikesResultMap">
		SELECT *
			FROM(
				SELECT L_NO,
				       M_NO,
				       RV_NO,
				       CMT_NO,
				       F_CODE,
				       F_TYPE,
				       F_LIKES,
				       F_STAR,
				       L_DATE,
				       L_UPDATE
				FROM REVIEW_LIKES
				WHERE M_NO = #{mNo} AND F_STAR > 0 AND F_CODE=#{fCode}
				ORDER BY L_UPDATE DESC)
			WHERE ROWNUM = 1
	</select>
	
	<!-- 별점 저장 -->
	<insert id="insertStar" parameterType="ReviewLikes">
		INSERT INTO REVIEW_LIKES(
	            L_NO,
	            M_NO,
	            F_CODE,
	            F_TYPE,
	            F_STAR
		      )
		      VALUES(
		            SEQ_LIKES_NO.NEXTVAL,
		            #{mNo},
		            #{fCode},
		            'movie',
		            #{fStar}
		      )
	</insert>
	
</mapper>